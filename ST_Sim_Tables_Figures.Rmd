---
title: "Summary of Spatiotemporal Power Analysis"
author: "Daniel J Hocking"
date: "2/11/2016"
output: html_document
---

```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
library(ggplot2)
library(dplyr)
df_sims <- read.csv(file = "Output/Power_Sim/STsim_Results.csv", header = TRUE, stringsAsFactors = FALSE)
#df_sims <- readRDS(file = "Output/Power_Sim/STsim_Results.RData")
load( "Data/White_River_Network.RData")
colnames(family)[1] = "child_name"
family = cbind( family, "child_b"=1:nrow(family) )
```


```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
theme_bw_journal <- function (base_family = "") {
  theme_grey(base_family = base_family) %+replace%
  theme(
  axis.text = element_text(size = rel(0.8)), axis.ticks = element_line(colour = "black"),
  legend.key = element_rect(colour = "grey80"), panel.background = element_rect(fill = "white",
  colour = NA), panel.border = element_rect(fill = NA,
  colour = "grey50"), panel.grid.major = element_line(colour = "grey90",
  size = 0.2), panel.grid.minor = element_line(colour = "grey98",
  size = 0.5), strip.background = element_rect(
  fill = "grey80",
  colour = "grey50", size = 0.2
  )
  )
  }
  
  theme_set(theme_bw_journal())
```


```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
df_sim_summary <- df_sims %>%
  dplyr::group_by(n_sites, n_years, spatialTF) %>%
  dplyr::select(-iter) %>%
  dplyr::summarise_each(funs(mean(., na.rm = T)))
as.data.frame(df_sim_summary %>% dplyr::filter(spatialTF == 1)) 

df_converged <- df_sims %>%
  dplyr::group_by(n_sites, n_years, spatialTF) %>%
  #dplyr::filter(converged == TRUE) %>%
  dplyr::mutate(n_sites_c = as.character(n_sites),
                n_years_c = as.character(n_years),
                spatialTF_c = as.character(spatialTF)) %>%
  dplyr::filter(theta_hat < 25) # no way converged
```

I ran 200 simulations of the spatiotemporal model for the White River in Vermont with 359 nodes (~330 stream reaches) over 20 years. For each iteration I then sampled the data to simulate surveying various numbers of sites for differing numbers of years (all combinations of 4, 8, 10, 15, 20 years for 25, 50, 100, 359 sites). For each survey combination in each iteration I fit the model including either spatial, temporal, and spatiotemporal dynamics (attempting to match the data generating model) or just a temporal model with no spatial or spatiotemporal dynamics.

This is a summary of the results varying the number of years averaged across the number of sites sampled (consider separating this out and just summarizing for the maximum number of sites or n_sites = 100 to more clearly isolate the year effects). The red dashed line is the true value.

```{r year plots, echo=FALSE, warning=FALSE, message=FALSE, fig.height=10, fig.width=10}
# consider separating this out and just summarizing for the maximum number of sites or n_sites = 100 to more clearly isolate the year effects

df_spatial <- df_converged %>%
  dplyr::filter(spatialTF == TRUE)

# Make the plots
y_N <- ggplot(df_converged, aes(n_years, mean_N_est, group = interaction(n_years, spatialTF))) + geom_boxplot(aes(fill = factor(spatialTF)), outlier.colour = "NA") + scale_fill_manual(values=c("#F8766D", "#619CFF"), name = "Spatial", labels = c("FALSE", "TRUE")) + geom_hline(yintercept = mean(df_converged$mean_N, na.rm = T), linetype = 2, size = 1, colour = "red") + theme(legend.position = "top") + xlab("") + geom_text(x = 5, y = 65, label = "b", size = 10) + coord_cartesian(ylim = c(0, 30))

y_N_se <- ggplot(df_converged, aes(n_years, N_se, group = interaction(n_years, spatialTF))) + geom_boxplot(aes(fill = factor(spatialTF)), outlier.colour = "NA") + scale_fill_manual(values=c("#F8766D", "#619CFF"), name = "Spatial", labels = c("FALSE", "TRUE")) + theme(legend.position = "none") + xlab("") + geom_text(x = 5, y = 65, label = "b", size = 10) + coord_cartesian(ylim = c(0, 6))

y_gamma <- ggplot(df_converged, aes(n_years, gamma_j_hat, group = interaction(n_years, spatialTF))) + geom_boxplot(aes(fill = factor(spatialTF)), outlier.colour = "NA") + scale_fill_manual(values=c("#F8766D", "#619CFF"), name = "Spatial", labels = c("FALSE", "TRUE")) + geom_hline(yintercept = df_converged$gamma_j, linetype = 2, size = 1, colour = "red") + theme(legend.position = "none") + xlab("") + geom_text(x = 5, y = 65, label = "b", size = 10) + coord_cartesian(ylim = c(0, 0.35))

y_RMSE <- ggplot(df_converged, aes(n_years, RMSE, group = interaction(n_years, spatialTF))) + geom_boxplot(aes(fill = factor(spatialTF)), outlier.colour = "NA") + scale_fill_manual(values=c("#F8766D", "#619CFF"), name = "Spatial", labels = c("FALSE", "TRUE")) + theme(legend.position = "none") + xlab("") + geom_text(x = 5, y = 65, label = "b", size = 10) + coord_cartesian(ylim = c(0, 40))

y_theta <- ggplot(df_spatial, aes(n_years, theta_hat, group = n_years)) + geom_boxplot(aes(fill = "#619CFF"), outlier.colour = "NA") + scale_fill_manual(values=c("#619CFF"), name = "Spatial", labels = c("FALSE", "TRUE"))  + theme(legend.position="none") + geom_hline(yintercept = df_spatial$theta, linetype = 2, size = 1, colour = "red") + xlab("") + geom_text(x = 5, y = 65, label = "b", size = 10) + coord_cartesian(ylim = c(0.1, 0.55))

y_SD <- ggplot(df_spatial, aes(n_years, SD_hat, group = n_years)) + geom_boxplot(aes(fill = "#619CFF"), outlier.colour = "NA") + scale_fill_manual(values=c("#619CFF"), name = "Spatial", labels = c("FALSE", "TRUE")) + geom_hline(yintercept = df_spatial$SD, linetype = 2, size = 1, colour = "red") + theme(legend.position = "none") + geom_text(x = 5, y = 65, label = "b", size = 10) + coord_cartesian(ylim = c(0, 0.15))

y_rhot <- ggplot(df_converged, aes(n_years, rhot_hat, group = interaction(n_years, spatialTF))) + geom_boxplot(aes(fill = factor(spatialTF)), outlier.colour = "NA") + scale_fill_manual(values=c("#F8766D", "#619CFF"), name = "Spatial", labels = c("FALSE", "TRUE")) + geom_hline(yintercept = df_converged$rhot, linetype = 2, size = 1, colour = "red") + theme(legend.position = "none") + xlab("") + geom_text(x = 5, y = 65, label = "b", size = 10) + coord_cartesian(ylim = c(-1, 1))

y_sigmat <- ggplot(df_converged, aes(n_years, sigmat_hat, group = interaction(n_years, spatialTF))) + geom_boxplot(aes(fill = factor(spatialTF)), outlier.colour = "NA") + scale_fill_manual(values=c("#F8766D", "#619CFF"), name = "Spatial", labels = c("FALSE", "TRUE")) + geom_hline(yintercept = df_converged$sigmat, linetype = 2, size = 1, colour = "red") + theme(legend.position = "none") + xlab("") + geom_text(x = 5, y = 65, label = "b", size = 10) + coord_cartesian(ylim = c(0, 1.2))

y_thet_st <- ggplot(df_spatial, aes(n_years, theta_st_hat, group = n_years)) + geom_boxplot(aes(fill = "#619CFF"), outlier.colour = "NA") + scale_fill_manual(values=c("#619CFF"), name = "Spatial", labels = c("FALSE", "TRUE")) + geom_hline(yintercept = df_spatial$theta_st, linetype = 2, size = 1, colour = "red") + theme(legend.position = "none") + geom_text(x = 5, y = 65, label = "b", size = 10) + coord_cartesian(ylim = c(0, 1))

y_SD_st <- ggplot(df_spatial, aes(n_years, SD_st_hat, group = n_years)) + geom_boxplot(aes(fill = "#619CFF"), outlier.colour = "NA") + scale_fill_manual(values=c("#619CFF"), name = "Spatial", labels = c("FALSE", "TRUE")) + geom_hline(yintercept = df_spatial$SD_st, linetype = 2, size = 1, colour = "red") + theme(legend.position = "none") + geom_text(x = 5, y = 65, label = "b", size = 10) + coord_cartesian(ylim = c(0.3, 0.7))

y_rho_st <- ggplot(df_spatial, aes(n_years, rho_st_hat, group = n_years)) + geom_boxplot(aes(fill = "#619CFF"), outlier.colour = "NA") + scale_fill_manual(values=c("#619CFF"), name = "Spatial", labels = c("FALSE", "TRUE")) + geom_hline(yintercept = df_spatial$rho_st, linetype = 2, size = 1, colour = "red") + theme(legend.position = "none") + geom_text(x = 5, y = 65, label = "b", size = 10) + coord_cartesian(ylim = c(0.3, 0.75))

# Save the legend
get_legend<-function(myggplot){
  tmp <- ggplot_gtable(ggplot_build(myggplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
}

legend <- get_legend(y_N)

# Remove the legend from the box plot
y_N <- y_N + theme(legend.position="none")

# Create a blank plot
# library(cowplot)
# blank_plot <- ggplot()+geom_blank(aes(1,1)) + 
#   cowplot::theme_nothing()

# Create grid of plots
library(gridExtra)
grid.arrange(y_gamma, legend, y_N, y_RMSE, y_theta, y_SD, y_rhot, y_sigmat, y_rho_st, y_SD_st, ncol = 2, nrow = 5, widths = c(2.7, 2.7), heights = c(rep(3, times=5)))

#grid.arrange(blank_plot, legend, y_N, y_N_se, y_RMSE, y_theta, y_rhot, y_sigmat, y_thet_st, y_rho_st, ncol = 2, nrow = 5, widths = c(2.7, 2.7), heights = c(0.2, rep(2.5, times=4))) # y_gamma, 

y_grid <- arrangeGrob(y_N + xlab(""), legend, 
             y_theta + xlab(""), y_SD + xlab(""), 
             y_rho_st + xlab(""), y_SD_st + xlab(""),
             y_rhot + xlab(""), y_sigmat + xlab(""),
             y_RMSE + xlab(expression(paste("Number of years"))), y_gamma + xlab(expression(paste("Number of years"))), 
             ncol = 2, 
             nrow = 5, 
             widths = c(2.7, 2.7), 
             heights = c(rep(5, times=5)))

ggsave(file = "Output/Power_Sim/ST_years.png", y_grid, dpi = 72)
ggsave(file = "Output/Power_Sim/ST_years.pdf", y_grid, dpi = 300)

grid::grid.draw(y_grid)

```

These results are not encouraging in that the spatial (theta), temporal (rhot, sigmat), and spatiotemporal (theta_st, rho_st) coefficients are not recovered well. However, the RMSE is improved with more sample years and by including the spatially explicit effects in the estimation. Although the mean abundance (mean_N) across sites is recovered well in all models, the precision in the estimate of the mean abundance in the watershed is improved with sample years and by the spatial model when there are few years.

Below are the results for different numbers of survey sites averaged across all numbers of survey years (consider separating this out and just summarizing for the maximum number of years or n_years = 20 to more clearly isolate the site effects) 

```{r site plots, echo=FALSE, results='hide', warning=FALSE, message=FALSE, fig.height=10, fig.width=10}
# consider separating this out and just summarizing for the maximum number of years or n_years = 20 to more clearly isolate the site effects

# Make the plots
s_N <- ggplot(df_converged, aes(n_sites, mean_N_est, group = interaction(n_sites, spatialTF))) + geom_boxplot(aes(fill = factor(spatialTF)), outlier.colour = "NA") + scale_fill_manual(values=c("#F8766D", "#619CFF"), name = "Spatial", labels = c("FALSE", "TRUE")) + geom_hline(yintercept = mean(df_converged$mean_N, na.rm = T), linetype = 2, size = 1, colour = "red") + theme(legend.position = "top") + xlab("") + geom_text(x = 5, y = 65, label = "b", size = 10) + coord_cartesian(ylim = c(0, 25))

# s_N_se <- ggplot(df_converged, aes(n_sites, N_se, group = interaction(n_sites, spatialTF))) + geom_boxplot(aes(fill = factor(spatialTF)), outlier.colour = "NA") + scale_fill_manual(values=c("#F8766D", "#619CFF"), name = "Spatial", labels = c("FALSE", "TRUE")) + theme(legend.position = "none") + xlab("") + geom_text(x = 5, y = 65, label = "b", size = 10) + coord_cartesian(ylim = c(0, 6))

s_gamma <- ggplot(df_converged, aes(n_sites, gamma_j_hat, group = interaction(n_sites, spatialTF))) + geom_boxplot(aes(fill = factor(spatialTF)), outlier.colour = "NA") + scale_fill_manual(values=c("#F8766D", "#619CFF"), name = "Spatial", labels = c("FALSE", "TRUE")) + geom_hline(yintercept = df_converged$gamma_j, linetype = 2, size = 1, colour = "red") + theme(legend.position = "none") + xlab("") + geom_text(x = 5, y = 65, label = "b", size = 10) + coord_cartesian(ylim = c(0, 0.42))

s_RMSE <- ggplot(df_converged, aes(n_sites, RMSE, group = interaction(n_sites, spatialTF))) + geom_boxplot(aes(fill = factor(spatialTF)), outlier.colour = "NA") + scale_fill_manual(values=c("#F8766D", "#619CFF"), name = "Spatial", labels = c("FALSE", "TRUE")) + theme(legend.position = "none") + xlab("") + geom_text(x = 5, y = 65, label = "b", size = 10) + coord_cartesian(ylim = c(0, 35))

s_theta <- ggplot(df_spatial, aes(n_sites, theta_hat, group = n_sites)) + geom_boxplot(aes(fill = "#619CFF"), outlier.colour = "NA") + scale_fill_manual(values=c("#619CFF"), name = "Spatial", labels = c("FALSE", "TRUE"))  + theme(legend.position="none") + geom_hline(yintercept = df_spatial$theta, linetype = 2, size = 1, colour = "red") + xlab("") + geom_text(x = 5, y = 65, label = "b", size = 10) + coord_cartesian(ylim = c(0.05, 0.6))

s_SD <- ggplot(df_spatial, aes(n_sites, SD_hat, group = n_sites)) + geom_boxplot(aes(fill = "#619CFF"), outlier.colour = "NA") + scale_fill_manual(values=c("#619CFF"), name = "Spatial", labels = c("FALSE", "TRUE")) + geom_hline(yintercept = df_spatial$SD, linetype = 2, size = 1, colour = "red") + theme(legend.position = "none") + geom_text(x = 5, y = 65, label = "b", size = 10) + coord_cartesian(ylim = c(0, 0.15))

s_rhot <- ggplot(df_converged, aes(n_sites, rhot_hat, group = interaction(n_sites, spatialTF))) + geom_boxplot(aes(fill = factor(spatialTF)), outlier.colour = "NA") + scale_fill_manual(values=c("#F8766D", "#619CFF"), name = "Spatial", labels = c("FALSE", "TRUE")) + geom_hline(yintercept = df_converged$rhot, linetype = 2, size = 1, colour = "red") + theme(legend.position = "none") + xlab("") + geom_text(x = 5, y = 65, label = "b", size = 10) + coord_cartesian(ylim = c(-1, 1))

s_sigmat <- ggplot(df_converged, aes(n_sites, sigmat_hat, group = interaction(n_sites, spatialTF))) + geom_boxplot(aes(fill = factor(spatialTF)), outlier.colour = "NA") + scale_fill_manual(values=c("#F8766D", "#619CFF"), name = "Spatial", labels = c("FALSE", "TRUE")) + geom_hline(yintercept = df_converged$sigmat, linetype = 2, size = 1, colour = "red") + theme(legend.position = "none") + xlab("") + geom_text(x = 5, y = 65, label = "b", size = 10) + coord_cartesian(ylim = c(0, 1.3))

s_thet_st <- ggplot(df_spatial, aes(n_sites, theta_st_hat, group = n_sites)) + geom_boxplot(aes(fill = "#619CFF"), outlier.colour = "NA") + scale_fill_manual(values=c("#619CFF"), name = "Spatial", labels = c("FALSE", "TRUE")) + geom_hline(yintercept = df_spatial$theta_st, linetype = 2, size = 1, colour = "red") + theme(legend.position = "none") + geom_text(x = 5, y = 65, label = "b", size = 10) +  coord_cartesian(ylim = c(0.05, 0.6))

s_SD_st <- ggplot(df_spatial, aes(n_sites, SD_st_hat, group = n_sites)) + geom_boxplot(aes(fill = "#619CFF"), outlier.colour = "NA") + scale_fill_manual(values=c("#619CFF"), name = "Spatial", labels = c("FALSE", "TRUE")) + geom_hline(yintercept = df_spatial$SD_st, linetype = 2, size = 1, colour = "red") + theme(legend.position = "none") + geom_text(x = 5, y = 65, label = "b", size = 10) + coord_cartesian(ylim = c(0.25, 0.75))

s_rho_st <- ggplot(df_spatial, aes(n_sites, rho_st_hat, group = n_sites)) + geom_boxplot(aes(fill = "#619CFF"), outlier.colour = "NA") + scale_fill_manual(values=c("#619CFF"), name = "Spatial", labels = c("FALSE", "TRUE")) + geom_hline(yintercept = df_spatial$rho_st, linetype = 2, size = 1, colour = "red") + theme(legend.position = "none") + geom_text(x = 5, y = 65, label = "b", size = 10) + coord_cartesian(ylim = c(0.25, 0.75))

# Save the legend
get_legend<-function(myggplot){
  tmp <- ggplot_gtable(ggplot_build(myggplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
}

legend <- get_legend(s_N)

# Remove the legend from the box plot
s_N <- s_N + theme(legend.position="none")

# Create a blank plot
# library(cowplot)
# blank_plot <- ggplot()+geom_blank(aes(1,1)) + 
#   cowplot::theme_nothing()

# Create grid of plots
library(gridExtra)
grid.arrange(s_gamma, legend, s_N, s_RMSE, s_theta, s_SD, s_rhot, s_sigmat, s_rho_st, s_SD_st, ncol = 2, nrow = 5, widths = c(2.7, 2.7), heights = c(rep(3, times=5)))

#grid.arrange(blank_plot, legend, s_N, s_N_se, s_RMSE, s_theta, s_rhot, s_sigmat, s_thet_st, s_rho_st, ncol = 2, nrow = 5, widths = c(2.7, 2.7), heights = c(0.2, rep(2.5, times=4))) # s_gamma, 

s_grid <- arrangeGrob(s_N + xlab(""), legend, 
             s_theta + xlab(""), s_SD + xlab(""), 
             s_rho_st + xlab(""), s_SD_st + xlab(""),
             s_rhot + xlab(""), s_sigmat + xlab(""),
             s_RMSE + xlab(expression(paste("Number of sites"))), s_gamma + xlab(expression(paste("Number of sites"))), 
             ncol = 2, 
             nrow = 5, 
             widths = c(2.7, 2.7), 
             heights = c(rep(5, times=5)))

ggsave(file = "Output/Power_Sim/ST_sites.png", s_grid, dpi = 72)
ggsave(file = "Output/Power_Sim/ST_sites.pdf", s_grid, dpi = 300)

grid::grid.draw(s_grid)

```

This is somewhat similar to the results comparing number of years surveyed. One strange result is that sigmat_hat gets worse with the spatiotemporal model with an increase in the number of sites surveyed. Another is that theta_st_hat is biased low, close to zero.

I really don't know what's going on with these results. I'm not positive if my generating model is matching my estimating model.

The code for the simulations is at: [https://github.com/djhocking/Trout_GRF/blob/master/Code/ST_Power_Analysis.R](https://github.com/djhocking/Trout_GRF/blob/master/Code/ST_Power_Analysis.R)

The code for the data generator is at: [https://github.com/djhocking/Trout_GRF/blob/master/Functions/simST.R](https://github.com/djhocking/Trout_GRF/blob/master/Functions/simST.R)

## Make Maps

```{r libraries and data, echo=FALSE, warning=FALSE, message=FALSE}
#library(maps)
library(sp, verbose = TRUE, quietly = TRUE, warn.conflicts = FALSE)
library(raster, verbose = TRUE, quietly = TRUE, warn.conflicts = FALSE)
library(rgdal, verbose = TRUE, quietly = TRUE, warn.conflicts = FALSE)
library(ggplot2, verbose = TRUE, quietly = TRUE, warn.conflicts = FALSE)
library(dplyr, verbose = TRUE, quietly = TRUE, warn.conflicts = FALSE)
library(grid, verbose = TRUE, quietly = TRUE, warn.conflicts = FALSE)
library(gridExtra, verbose = TRUE, quietly = TRUE, warn.conflicts = FALSE)
#library(ggmap)

# load data
dem <- raster(x = "Data/layers/demwhite")
flowlines <- rgdal::readOGR(dsn = "Data/layers/flowlinesWhite", layer = "flowlinesWhite")
sites <- rgdal::readOGR(dsn = "Data/layers/pointsWhite", layer = "pointsWhite")
load( "Data/White_River_Network.RData") # family defines spatial relationship in network
colnames(family)[1] = "child_name"
family = cbind( family, "child_b"=1:nrow(family) )
```

### Projections

Make sure projections are the same across all data

```{r projections, echo=FALSE, warning=FALSE, message=FALSE}
# get data in same projection
print(proj4string(dem))
print(proj4string(sites))

# flowlines_prj <- spTransform(flowlines, crs(projection(dem)))
# sites_prj <- spTransform(sites, crs(projection(dem)))

new_crs <- "+proj=longlat + ellps=WGS84 +towgs84=0,0,0"
dem <- projectRaster(dem, crs = new_crs)
flowlines_prj <- spTransform(flowlines, crs(projection(dem)))
sites_prj <- spTransform(sites, crs(projection(dem)))
# str(flowlines_prj)
```

```{r add abundance, warning=FALSE, message=FALSE, echo=FALSE, eval=TRUE}
# Add abundance data to flowlines
#load("Output/Power_Sim/Data/sim_188_st_1_sites_359_years_20.RData") # includes simulated data and model results
load("Output/Power_Sim/Data/sim_137_st_1_sites_50_years_8.RData")

# make dataframe of abundance across network
df_N <- data.frame(child_name = rep(family$child_name, times = max(network$t_i)), year = network$t_i, N = network$N_i, N_hat = mod$Report$N_ip[ , 1], stringsAsFactors = FALSE)

```

Prepare data for ggplot:

```{r prep ggplot data, echo=FALSE, warning=FALSE, message=FALSE}
# convert flowlines to dataframe for ggplot2
flowlines_f <- ggplot2::fortify(flowlines_prj)

# convert dem to dataframe for ggplot
dem_df <- data.frame(rasterToPoints(dem), stringsAsFactors = FALSE)
colnames(dem_df) <- c("Longitude", "Latitude", "Elevation")



```


```{r ggplot group 2, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8, fig.height=10, fig.align='center'}
my_breaks = c(0, 10, 20, 30, 40, 50)
# Set colors related to abundance (N_hat)
colors <- colorRampPalette(c('cyan','blue'))(max(max(df_N$N_hat), max(df_N$N)))
colors <- colorRampPalette(c('blue','red'))(max(max(df_N$N_hat), max(df_N$N)))
colors <- colorRampPalette(colors = c('blue','red'))(length(my_breaks))

p_hat <- list()
p_true <- list()
for(t in unique(df_N$year)) {
# Add abundance and year to flowlines data
    flow <- flowlines_prj
flow@data <- dplyr::left_join(as.data.frame(flow@data, stringsAsFactors = FALSE), df_N[which(df_N$year == t), ], by = c("nodeID" = "child_name"))

# add id to flowlines data
flowlines_df <- data.frame(id=rownames(flow@data),
                        flow@data, 
                        stringsAsFactors=F)

# combine flowlines data to include both spatial info and other covariate info, then limit to the first year of data
flowlines_df <- left_join(flowlines_f, flowlines_df, by = "id") %>%
  dplyr::filter(year == t)

p_hat[[t]] <- ggplot(dem_df, aes(Longitude, Latitude)) + geom_path(data = flowlines_df, aes(x=long, y=lat, group = group, colour = N_hat), size = 0.8) + scale_color_gradient2("Abundance", low = "blue", mid = "blue", high = "red", breaks = my_breaks, labels = my_breaks, limits = c(0, 50), na.value = "red") + theme_bw() + coord_equal(ratio=1) 

p_true[[t]] <- ggplot(dem_df, aes(Longitude, Latitude)) + geom_path(data = flowlines_df, aes(x=long, y=lat, group = group, colour = N), size = 0.8) + scale_color_gradient2("Abundance", mid = "blue", high = "red", breaks = my_breaks, labels = my_breaks, limits = c(0, 50), na.value = "red") + theme_bw() + coord_equal(ratio=1) 

#p_true[[t]] <- ggplot(dem_df, aes(Longitude, Latitude)) + geom_path(data = flowlines_df, aes(x=long, y=lat, group = group, colour = N), size = 0.8) + scale_color_gradientn("Abundance", colours = colors, breaks = my_breaks, labels = my_breaks) + coord_equal(ratio=1) + theme_bw()
}

# summarise to see what years to best show variation
N_sum <- df_N %>%
  dplyr::group_by(year) %>%
  dplyr::summarise(N_mean = mean(N),
                   N_sd = sd(N))

# arrange in columns
# grid.arrange(p_true[[2]] + ggtitle("Year 1"), p_hat[[2]] + ggtitle("Year 1") + theme(legend.position="none", axis.title.x = element_blank()),
#              p_true[[4]], p_hat[[4]],
#              p_true[[6]], p_hat[[6]],
#              p_true[[8]], p_hat[[8]],
#              p_true[[10]], p_hat[[10]],
#              ncol = 2) #, widths = c(4, 4), heights = c(4,4,4))

# create blank plot
blank <- grid.rect(gp = gpar(col = "white"))

g_legend <- function(a.gplot) {
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
  }

my_legend <- g_legend(p_true[[1]])

# Arrange in rows
st_grid <- arrangeGrob(p_true[[2]] + ggtitle("N: Year 2") + theme(legend.position="none", axis.title.x = element_blank(), axis.title.y = element_blank()),
             p_true[[4]] + ggtitle("N: Year 4") + theme(legend.position="none", axis.title.x = element_blank(), axis.title.y = element_blank()),
             p_true[[6]] + ggtitle("N: Year 6") + theme(legend.position="none", axis.title.x = element_blank(), axis.title.y = element_blank()),
             p_true[[8]] + ggtitle("N: Year 8") + theme(legend.position="none", axis.title.x = element_blank(), axis.title.y = element_blank()),
             p_true[[10]] + ggtitle("N: Year 10") + theme(legend.position="none", axis.title.x = element_blank(), axis.title.y = element_blank()),
             my_legend,
             p_hat[[2]] + ggtitle(expression(paste(widehat(N), ": Year 2"))) + theme(legend.position="none", axis.title.y = element_blank()),
             p_hat[[4]] + ggtitle(expression(paste(widehat(N), ": Year 4"))) + theme(legend.position="none", axis.title.y = element_blank()),
             p_hat[[6]] + ggtitle(expression(paste(widehat(N), ": Year 6"))) + theme(legend.position="none", axis.title.y = element_blank()),
             p_hat[[8]] + ggtitle(expression(paste(widehat(N), ": Year 8"))) + theme(legend.position="none", axis.title.y = element_blank()),
             p_hat[[10]] + ggtitle(expression(paste(widehat(N), ": Year 10"))) + theme(legend.position="none", axis.title.y = element_blank()),
             my_legend,
             nrow = 2,
             heights = c(4, 4),
             widths = c(5, 5, 5, 5, 5, 2))
             
ggsave(filename = "Output/Power_Sim/ST_Grid.png", plot = st_grid, width = 11, height = 6, units = "in")
ggsave(filename = "Output/Power_Sim/ST_Grid.pdf", plot = st_grid, dpi = 300, width = 11, height = 6, units = "in")

grid::grid.draw(st_grid)
```
